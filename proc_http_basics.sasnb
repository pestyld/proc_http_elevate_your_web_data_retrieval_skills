[{"kind":1,"language":"markdown","value":"# SAS PROC HTTP: Elevate Your Web Data Retrieval Skills\r\n[HTTP Procedure Documentation](https://go.documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/proc/n0bdg5vmrpyi7jn1pbgbje2atoov.htm)","outputs":[]},{"kind":2,"language":"sas","value":"/* REQUIRED: Set path to your main folder */\r\n%let path = C:\\Users\\pestyl\\OneDrive - SAS\\github repos\\proc_http_elevate_your_web_data_retrieval_skills; /* My local path */\r\n*%let path = %SYSGET(HOME);                                                                               /* My viya path */\r\n\r\n/* View path */\r\n%put &=path;\r\n\r\n\r\n\r\n%macro viewData(myData,total=50);\r\n/* \r\n    The macro previews 50 rows of your table by default.\r\n\r\n    Parameters:\r\n        myData - specify the library and table name\r\n        obs - number of rows to preview. Default is 50.\r\n*/\r\n\r\n    title height=16pt \"TABLE: %upcase(&myData)\";\r\n    proc print data=&myData(obs=&total);\r\n    run;\r\n    title;\r\n\r\n%mend;\r\n\r\n\r\n%macro showImage(image);\r\n/* \r\n    The macro renders images in the SAS notebook or SAS results.\r\n\r\n    Parameter:\r\n        image - specify the full path and file name within quotes.\r\n*/\r\n\r\n    data _null_;\r\n        declare odsout obj();\r\n        obj.image(file:&image);\r\n    run;\r\n\r\n%mend;","outputs":[]},{"kind":1,"language":"markdown","value":"## 1. Simple GET request\r\n### a. Store the CSV file response on the server. \r\n- View the output, notice the NOTE: 200 OK indicates the request was successful.\r\n- Vew the data folder, notice that the file has been saved.","outputs":[]},{"kind":2,"language":"sas","value":"filename resp \"&path/data/01_cars.csv\"; /* Create file to save download to */\r\n\r\nproc http \r\n   method=\"GET\" \r\n   url=\"https://support.sas.com/documentation/onlinedoc/viya/exampledatasets/cars.csv\"\r\n   out=resp;\r\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"Use traditional SAS methods to import the CSV file into SAS and process the data.","outputs":[]},{"kind":2,"language":"sas","value":"proc import datafile=resp      /* Specify the CSV file reference */\r\n            dbms=csv \r\n            out=work.mycars;   /* Create the SAS table */\r\nrun;\r\n\r\n/* Preview the data using the user macro */\r\n%viewData(work.mycars, total=10)","outputs":[]},{"kind":1,"language":"markdown","value":"### b. Store the JSON file response on the server. \r\nUsing [httpbin.org](https://httpbin.org/) for demonstration purposes. It is a simple HTTP Request & Response Service.","outputs":[]},{"kind":2,"language":"sas","value":"filename resp \"&path/data/02_simple_get_request.json\";  /* Store JSON response in the new JSON file */\r\n\r\nproc http \r\n   method=\"GET\" \r\n   url=\"http://httpbin.org/get\"\r\n   out=resp;\r\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"### c. Store the response as a temporary file on SAS. \r\nUse this method if you don't want to download the file permanently, but want to use it for your process.  ","outputs":[]},{"kind":2,"language":"sas","value":"filename resp temp;\r\n\r\nproc http \r\n   method=\"GET\" \r\n   url=\"http://httpbin.org/get\"\r\n   out=resp;\r\nrun;\r\n\r\n/* View the temporary JSON file using a DATA NULL step with the jsonpp function */\r\ndata _NULL_;\r\n    rc = jsonpp('resp','log');  /* JSONPP is JSON pretty print, easier to read */\r\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"### d. PROC HTTP Response Status Macro Variables\r\nBeginning with SAS 9.4M5, PROC HTTP sets up macro variables with certain values after it executes each statement. These macro variables can be used inside a macro to test for HTTP errors. An HTTP error is an error that is encountered after a successful host connection has been made and the HTTP request has been successfully parsed by the HTTP procedure. The macro variables do not store values for host connection errors or for PROC HTTP syntax errors. The macro variables are reset on each invocation of PROC HTTP.\r\n\r\n\r\nSYS_PROCHTTP_STATUS_CODE\r\nstores the status code of the HTTP request.\r\n\r\nSYS_PROCHTTP_STATUS_PHRASE\r\nstores the descriptive phrase that is associated with the status code.\r\n\r\n[PROC HTTP Response Status Macro Variables](https://go.documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/proc/p0mwmz1upde0tqn1ptt5rnlly0tc.htm)","outputs":[]},{"kind":2,"language":"sas","value":"%put &=SYS_PROCHTTP_STATUS_CODE;\r\n%put &=SYS_PROCHTTP_STATUS_PHRASE;","outputs":[]},{"kind":1,"language":"markdown","value":"Create a simple macro program for the PROC HTTP response macro variable for your pipeline if necessary.","outputs":[]},{"kind":2,"language":"sas","value":"%macro check_for_200();\r\n    /* Success note if a response of 200 */\r\n    %if &SYS_PROCHTTP_STATUS_CODE  = 200 %then %do;\r\n        %put NOTE: Yay! Succesful PROC HTTP request! I did it!;\r\n    %end;\r\n    %else %do; /* If not 200, do the following */\r\n        /* Return HTTP response macro variable information */\r\n        %put ERROR: Terrible job. You did something wrong. Failed PROC HTTP request.;\r\n        %put ERROR: ERROR description: &SYS_PROCHTTP_STATUS_CODE &SYS_PROCHTTP_STATUS_PHRASE;\r\n        /*The %RETURN macro causes normal termination of the currently executing macro. */\r\n        %return; \r\n    %end;\r\n%mend;\r\n\r\n/* PRINT MESSAGE THAT CAME BACK AS AN ERROR WITHIN THE ELSE DO */\r\n\r\n%check_for_200;","outputs":[]},{"kind":1,"language":"markdown","value":"Get a an incorrect code check when using an invalid URL.","outputs":[]},{"kind":2,"language":"sas","value":"filename badreq temp;\r\n\r\nproc http \r\n   method=\"GET\" \r\n   url=\"http://httpbin.org/bad_address_adfkad\"    /* Invalid URL */\r\n   out=badreq\r\n   timeout=5; /* add timeout to end quicker */\r\nrun;\r\n\r\n/* Run the macro and view the log. Returns an error and stops processing */\r\n%check_for_200()","outputs":[]},{"kind":1,"language":"markdown","value":"## 2. Working with a JSON File (JSON LIBNAME ENGINE)\r\nView the JSON response in the log with the DATA step.","outputs":[]},{"kind":2,"language":"sas","value":"/* Rerun the code to download the file */\r\nfilename resp \"&path/data/02_simple_get_request.json\";\r\n\r\n/* Send request */\r\nproc http \r\n   method=\"GET\" \r\n   url=\"http://httpbin.org/get\"\r\n   out=resp;\r\nrun;\r\n\r\n/* View the file in the JSON file in the log with indentations */\r\ndata _null_;\r\n\trc = jsonpp('resp','log');\r\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"### a. Create a SAS library to the JSON response file.\r\nNotice that SAS creates 4 tables in the library.","outputs":[]},{"kind":2,"language":"sas","value":"/* Create a library reference to the JSON file using the JSON engine */\r\nlibname resp json fileref=resp;\r\n\r\n/* View the library and tables that are created */\r\nproc contents data=resp._all_ nods;\r\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"Preview each table in the library.","outputs":[]},{"kind":2,"language":"sas","value":"%viewData(resp.alldata)\r\n%viewData(resp.root)\r\n%viewData(resp.args)\r\n%viewData(resp.headers)","outputs":[]},{"kind":1,"language":"markdown","value":"### b. Store a value from the response in a macro variable\r\n**Scenario:** Store the  **Host** value from the JSON file dictionary,  \"Host\": *\"httpbin.org\"*, in a macro variable to use later.","outputs":[]},{"kind":2,"language":"sas","value":"data _null_;\r\n    set resp.headers;\r\n    call symputx('hostValue', Host);\r\nrun;\r\n\r\n/* View the macro variable value */\r\n%put &=hostValue;","outputs":[]},{"kind":1,"language":"markdown","value":"### c. Join the JSON file objects into a single structured table.\r\nDepending on the JSON response, you might need to join the tables to create the final table for your objectives.","outputs":[]},{"kind":2,"language":"sas","value":"proc sql;\r\nSELECT *\r\nFROM resp.root as r\r\n    INNER JOIN resp.headers as h ON r.ordinal_root = h.ordinal_root;\r\nquit;","outputs":[]},{"kind":1,"language":"markdown","value":"## 3. Password Authentication\r\nUse user/password authentication with PROC HTTP.\r\n\r\n**FOLLOW ALL COMPANY POLICY REGARDING AUTHENTICATION.**\r\n\r\n### a. Simple user/password plain text\r\n\r\n**Scenario:** Forget to use user/password authentication when it's required.\r\n\r\nNotice that it returns a 401 Unauthorized response.","outputs":[]},{"kind":2,"language":"sas","value":"filename badpass temp;\r\n\r\nproc http \r\n   method=\"GET\" \r\n   url=\"https://httpbin.org/basic-auth/myusername/pAssw0rd\"  /*username is myusername, password is pAss0wrd */\r\n   out=badpass;\r\nrun;\r\n\r\n/* Add 200 checker */\r\n%check_for_200()","outputs":[]},{"kind":1,"language":"markdown","value":"Add the username/password in plain text (DEMO PURPOSES ONLY, DON'T ENTER YOUR USERNAME AND PASSWORD IN PLAIN TEXT EVER!).\r\n\r\nNotice that the results return 200 OK.","outputs":[]},{"kind":2,"language":"sas","value":"filename goodpass temp;\r\n\r\nproc http \r\n   method=\"GET\" \r\n   url=\"https://httpbin.org/basic-auth/myusername/pAssw0rd\"\r\n   webusername=\"myusername\"  /* username */\r\n   webpassword=\"pAssw0rd\"    /* password */\r\n   out=goodpass;\r\nrun;\r\n\r\ndata _NULL_;\r\n   rc = jsonpp('goodpass','log');\r\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"View the response from the server.","outputs":[]},{"kind":2,"language":"sas","value":"libname myfile json fileref=goodpass \r\n                    noalldata;  /* The NOALLDATA option removes the ALLDATA table. This can be more efficienct for large data */\r\n\r\n/* View all tables in the library */\r\nproc contents data=myfile._all_ nods;\r\nrun;\r\n\r\n/* Preview the root table */\r\n%viewData(myfile.root)\r\n\r\n/* Clear your library */\r\nlibname myfile close;","outputs":[]},{"kind":1,"language":"markdown","value":"### b. Store authentication information in macro variables\r\nAdd your authentication information within your autoexec or a program.\r\n\r\nPlease follow all company policy regarding authentication.","outputs":[]},{"kind":2,"language":"sas","value":"/* Execute the program that contains my authorization information */\r\n%include \"&path/auth/cred_plain_text.sas\";\r\n\r\n/* Create a temporary file */\r\nfilename goodpass temp;\r\n\r\nproc http \r\n   method=\"GET\" \r\n   url=\"https://httpbin.org/basic-auth/myusername/pAssw0rd\"\r\n   webusername=\"&username\"\r\n   webpassword=\"&password\"\r\n   out=goodpass;\r\nrun;\r\n\r\n/* View the response in the log */\r\ndata _null_;\r\n   view = jsonpp('goodpass','log');\r\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"### c. Encrypt your password\r\nAdd your authentication information within your autoexec or a program.\r\n\r\nResources:\r\n- [Five strategies to eliminate passwords from your SAS programs](https://blogs.sas.com/content/sasdummy/2010/11/23/five-strategies-to-eliminate-passwords-from-your-sas-programs/)\r\n- [PWENCODE Procedure Documentation](https://go.documentation.sas.com/doc/en/pgmsascdc/default/proc/n0dc6in0v7nfain1f2whl6f5x66p.htm)\r\n- [Example to Encode SAS Passwords](https://blogs.sas.com/content/sastraining/2008/12/05/example-to-encode-sas-passwords/)\r\n\r\nEncode your password.","outputs":[]},{"kind":2,"language":"sas","value":"proc pwencode in=\"pAssw0rd\"\r\n  method=sas002;\r\nrun;","outputs":[]},{"kind":2,"language":"sas","value":"/* Specify your encoded pasword in  macro variable */\r\n%let encodedPass = {SAS002}DA9A0A5C07B7C78E1F4B7FFA25F192A4;\r\n\r\nfilename goodpass temp;\r\n\r\nproc http \r\n   method=\"GET\" \r\n   url=\"https://httpbin.org/basic-auth/myusername/pAssw0rd\"\r\n   webusername=\"&username\"\r\n   webpassword=\"&encodedPass\"  /* Encoded password */\r\n   out=goodpass;\r\nrun;\r\n\r\n/* View the response in the log */\r\ndata _null_;\r\n   view = jsonpp('goodpass','log');\r\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"## 4. Bearer Authentication\r\n### a. Forget to provide token\r\nPrompts the user for authorization using bearer authentication. No auth is specified here so it will be unauthorized.","outputs":[]},{"kind":2,"language":"sas","value":"filename nobear temp;\r\n\r\nproc http \r\n   method=\"GET\" \r\n   url=\"https://httpbin.org/bearer\"\r\n   out=nobear;\r\nrun;\r\n\r\n/* View the response in the log */\r\ndata _null_;\r\n   view = jsonpp('nobear','log');\r\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"### b. Provide token for authentication","outputs":[]},{"kind":2,"language":"sas","value":"filename goodbear temp;\r\n\r\n/* Provide access token */\r\n%let access_token = gakdfdadfkae213913;\r\n\r\nproc http \r\n   method=\"GET\" \r\n   url=\"https://httpbin.org/bearer\" \r\n   oauth_bearer=\"&access_token\"       /* Access token */\r\n   out=goodbear;\r\nrun;\r\n\r\n/* View the response in the log */\r\ndata _null_;\r\n   view = jsonpp('goodbear','log');\r\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"## 5.Debugging options\r\n","outputs":[]},{"kind":2,"language":"sas","value":"filename resp temp;\r\n\r\nproc http \r\n        method=\"GET\" \r\n        url=\"http://httpbin.org/get/adfk/adskfbadaddress\"\r\n        out=resp;\r\n    debug level=1; /* More verbose information on how your machines are talking to each other */\r\nrun;","outputs":[]},{"kind":2,"language":"sas","value":"filename badpass temp;\r\n\r\nproc http \r\n        method=\"GET\" \r\n        url=\"https://httpbin.org/basic-auth/myusername/pAssw0rd\"\r\n        out=badpass\r\n        webusername='bad-user-name'\r\n        webpassword='bad-password';\r\n    debug level = 3;\r\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"## 6. End to End ETL Using JSON Data from the World Bank API\r\n### Using a Rest API","outputs":[]},{"kind":2,"language":"sas","value":"%showImage(\"&path/images/01_using_rest_api.jpg\")","outputs":[]},{"kind":2,"language":"sas","value":"%showImage(\"&path/images/02_parts_url_params.jpg\")","outputs":[]},{"kind":1,"language":"markdown","value":"### Scenario: View the GDP of Greece, Brazil and the United States from 2000 - 2022\r\n### a. JSON Response\r\nUse the API URL from the World Bank.\r\n\r\n[About the Indicators API Documentation](https://datahelpdesk.worldbank.org/knowledgebase/articles/889392-about-the-indicators-api-documentation)\r\n\r\n[Go to the World Bank API request below directly](https://api.worldbank.org/v2/country/GR;BR;US/indicator/NY.GDP.MKTP.CD/?format=json&per_page=100&date=2000:2022)\r\n\r\n#### 1. Get the JSON response.","outputs":[]},{"kind":2,"language":"sas","value":"/* Create temp JSON file for the JSON response */\r\nfilename jsonresp \"&path/data/03_GR_US_BR_GDP.json\";\r\n\r\n/*\r\n\tSend the GET request to the World Bank \r\n\tNotes: Be careful with special characters so you don't make the & call macro variables.\r\n\tParameters:\r\n\t- format = json\r\n\t- per_page = 100\r\n\t- date = 2000:2022\r\n*/\r\nproc http\r\n\turl = 'https://api.worldbank.org/v2/country/GR;BR;US/indicator/NY.GDP.MKTP.CD/?format=json&per_page=100&date=2000:2022'  \r\n\tout = jsonresp in='format=json&per_page'\r\n\tmethod='GET';\r\nrun;\r\n\r\n/* View the JSON contents */\r\ndata _null_;\r\n\tviewJson = jsonpp('jsonresp', 'log');\r\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"The QUERY= option makes adding query parameters to a URL easier. You can still add query parameters to a URL manually as shown above. This will achieve the same results. ","outputs":[]},{"kind":2,"language":"sas","value":"/* Create temp JSON file for the JSON response */\r\nfilename jsonresp \"&path/data/03_GR_US_BR_GDP.json\";\r\n\r\n/* Send the GET request to the World Bank */\r\nproc http\r\n\turl = 'https://api.worldbank.org/v2/country/GR;BR;US/indicator/NY.GDP.MKTP.CD/'\r\n\tout = jsonresp\r\n\tmethod='GET'\r\n    query = ('format'='json'         /* Use the the query option to add parameters */ /* check for viya3.5 */\r\n\t         'per_page'='300' \r\n\t\t\t 'date'='2000:2022'); \r\nrun;\r\n\r\n/* View the JSON contents */\r\ndata _null_;\r\n\tviewJson = jsonpp('jsonresp', 'log');\r\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"#### 2. Create a library to the JSON file.","outputs":[]},{"kind":2,"language":"sas","value":"libname jsonFile JSON fileref=jsonresp noalldata;\r\n\r\n/* View tables in the library */\r\nproc contents data=jsonFile._ALL_ nods;\r\nrun;\r\n\r\n/* Preview 20 rows from each table */\r\n%viewData(jsonFile.root,total=20)\r\n%viewData(jsonFile.country,total=20)\r\n%viewData(jsonFile.indicator,total=20)","outputs":[]},{"kind":1,"language":"markdown","value":"#### 3. Store the lastUpdated value in a macro to use later.","outputs":[]},{"kind":2,"language":"sas","value":"data _NULL_;\r\n    set jsonFile.root(obs=1);\r\n    call symputx('LastUpdatedDate',lastUpdated);\r\nrun;\r\n\r\n/* View the macro value */\r\n%put &=LastUpdatedDate;","outputs":[]},{"kind":1,"language":"markdown","value":"#### 4. Prepare the data into a single structured table","outputs":[]},{"kind":2,"language":"sas","value":"proc sql;\r\nCREATE TABLE work.countries_gdp AS \r\nSELECT r.countryiso3code as COUNTRYISO3CODE, \r\n\t   ctry.value as COUNTRY,\r\n\t   input(r.date,8.) as DATE,                 /* Convert char date to a SAS date value */\r\n\t   r.value as GDP format=dollar20.,\r\n\t   i.value AS GDP_VALUE\r\nFROM jsonFile.root as r \r\n\tINNER JOIN jsonFile.country as ctry ON r.ordinal_root=ctry.ordinal_root\r\n\tINNER JOIN jsonFile.indicator as i ON r.ordinal_root=i.ordinal_root\r\nORDER BY Country, Date;\r\nquit;","outputs":[]},{"kind":2,"language":"sas","value":"footnote \"Last Updated: &LastUpdatedDate\";\r\n%viewData(work.countries_gdp,total=35)","outputs":[]},{"kind":1,"language":"markdown","value":"#### 5. Simple analysis.","outputs":[]},{"kind":2,"language":"sas","value":"proc means data=work.countries_gdp;\r\n    class Country;\r\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"#### 6. Visualize the data.","outputs":[]},{"kind":2,"language":"sas","value":"/* Set macro variables with specified HEX colors */\r\n%let brazilColor=CX009739;\r\n%let USColor=CXb22234;\r\n%let greeceColor=CX0d5EAF;\r\n%let textGray=charcoal;\r\n\r\n\r\n/* Visualization */\r\ntitle justify=left height=14pt color=&textGray \"Comparative Analysis of GDP Trends: United States, Greece, and Brazil (2000-2022)\";\r\nfootnote justify=left italic height=10pt color=&textGray \"Data last updated on &LastUpdatedDate\";\r\n\r\nods graphics / width=10in height=5in;\r\nproc sgplot data=work.countries_gdp\r\n\t\t\tnoborder;\r\n\tstyleattrs datacontrastcolors=(&brazilColor &greeceColor &USColor);\r\n\tseries x=Date y=GDP / \r\n\t\tgroup=Country\r\n\t\tmarkers markerattrs=(symbol=circleFilled)\r\n\t\tcurvelabel;\r\n\txaxis valueattrs=(color=&textGray) \r\n\t\t  display=(nolabel)\r\n\t\t  values=(2000 to 2022 by 2);\r\n\tyaxis valueattrs=(color=&textGray) \r\n\t\t  labelpos=top labelattrs=(color=&textGray size=11pt) label='GDP (Current US$)';\r\n\tstyleattrs backcolor=white wallcolor=white;\r\nrun;\r\nods graphics / reset;\r\n\r\ntitle; footnote;\r\n","outputs":[]},{"kind":1,"language":"markdown","value":"### b. XML Response\r\nAchieves the same results as the JSON file above.\r\n\r\n#### 1. Get the XML response, save the file and view the raw XML data.","outputs":[]},{"kind":2,"language":"sas","value":"/* Create temp JSON file for the JSON response */\r\nfilename xmlresp \"&path/data/03_GR_US_BR_GDP.xml\";\r\n\r\n/* Send the GET request to the World Bank */\r\nproc http\r\n\turl = 'https://api.worldbank.org/v2/country/GR;BR;US/indicator/NY.GDP.MKTP.CD/'\r\n\tout = xmlresp\r\n\tmethod='GET'\r\n    query = ('format'='xml'         /* Changed to XML. Use the the query option to add parameters */\r\n\t         'per_page'='300' \r\n\t\t\t 'date'='2000:2022'); \r\nrun;\r\n\r\n/* View the XML contents */\r\ndata _null_;\r\n\tinfile xmlresp;\r\n    input;\r\n    put _infile_;\r\nrun;","outputs":[]},{"kind":2,"language":"sas","value":"/* View the XML contents */\r\ndata _null_;\r\n    file print;\r\n\tinfile xmlresp;\r\n    input;\r\n    put _infile_;\r\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"#### 2. Read an XML file and create a SAS table","outputs":[]},{"kind":2,"language":"sas","value":"/* Create a library to the XML file */\r\nfilename xml_map temp;\r\nlibname xmlFile xmlv2 xmlfileref=xmlresp \r\n                      xmlmap=xml_map \r\n                      automap=replace;\r\n\r\n/* View SAS library */\r\nproc contents data=xmlFile._all_ nods;\r\nrun;\r\n\r\n/* View data */\r\n/* Preview 20 rows from each table */\r\n%viewData(xmlFile.country,total=20)\r\n%viewData(xmlFile.data,total=20)\r\n%viewData(xmlFile.data1,total=20)\r\n%viewData(xmlFile.indicator,total=20)\r\n","outputs":[]},{"kind":1,"language":"markdown","value":"#### 3. Get the last updated date in a macro variable.","outputs":[]},{"kind":2,"language":"sas","value":"/* lastupdated column is a SAS date value */\r\nproc contents data=xmlFile.data;\r\nrun;\r\n\r\ndata _null_;\r\n    set xmlFile.DATA;\r\n    str_updated_date = put(data_lastupdated, mmddyy10.);   /* The XML last updated date is a SAS date value (numeric) with a format. Create a string date */\r\n    call symputx ('lastUpdatedDate',str_updated_date);\r\nrun;\r\n\r\n%put &=lastUpdatedDate;","outputs":[]},{"kind":1,"language":"markdown","value":"#### 4. Create a structured table.","outputs":[]},{"kind":2,"language":"sas","value":"proc sql;\r\ncreate table work.countries_gdp_xml as \r\n\tselect r.countryiso3code,\r\n\t\t   ctry.country as Country,\r\n\t\t   r.date,\r\n\t\t   input(r.value,best20.) as GDP format=dollar20.,\r\n\t\t   i.indicator\r\n\t\tfrom xmlFile.data1 as r \r\n\t\tinner join xmlFile.country as ctry \r\n\t\t\ton r.data1_ORDINAL=ctry.data1_ORDINAL\r\n\t\tinner join xmlFile.indicator as i \r\n\t\t\ton r.data1_ORDINAL=i.data1_ORDINAL\r\n\t\torder by Country, Date;\r\n;\r\nquit;\r\n\r\n%viewData(work.countries_gdp_xml, total=35)","outputs":[]},{"kind":1,"language":"markdown","value":"#### 5. Analyze the structured table.","outputs":[]},{"kind":2,"language":"sas","value":"proc means data=work.countries_gdp_xml;\r\n    class Country;\r\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"#### 6. Visualize the data.","outputs":[]},{"kind":2,"language":"sas","value":"/* Set macro variables with specified HEX colors */\r\n%let brazilColor=CX009739;\r\n%let USColor=CXb22234  ;\r\n%let greeceColor=CX0d5EAF;\r\n%let textGray=charcoal;\r\n\r\n/* Visualization */\r\ntitle justify=left height=14pt color=&textGray \"Comparative Analysis of GDP Trends: United States, Greece, and Brazil (2000-2022)\";\r\nfootnote justify=left italic height=10pt color=&textGray \"Data last updated on &lastUpdatedDate\";\r\n\r\nods graphics / width=10in height=5in;\r\nproc sgplot data=work.countries_gdp_xml\r\n\t\t\tnoborder;\r\n\tstyleattrs datacontrastcolors=(&brazilColor &greeceColor &USColor);\r\n\tseries x=Date y=GDP / \r\n\t\tgroup=Country\r\n\t\tmarkers markerattrs=(symbol=circleFilled)\r\n\t\tcurvelabel;\r\n\txaxis valueattrs=(color=&textGray) \r\n\t\t  display=(nolabel)\r\n\t\t  values=(2000 to 2022 by 2);\r\n\tyaxis valueattrs=(color=&textGray) \r\n\t\t  labelpos=top labelattrs=(color=&textGray size=11pt) label='GDP (Current US$)';\r\n\tstyleattrs backcolor=white wallcolor=white;\r\nrun;\r\nods graphics / reset;\r\n\r\ntitle; footnote;","outputs":[]},{"kind":1,"language":"markdown","value":"## 7. Web Scraping\r\n\r\nTest using the [Web Scraper test site](https://webscraper.io/test-sites).\r\n\r\n### a. Start by saving the HTML to a text file.","outputs":[]},{"kind":2,"language":"sas","value":"filename scrape \"&path/data/04_web_scrape.txt\";\r\n\r\n/* test site, I saved the HTML file in the data folder. Otherwise the HTML changes. */\r\n\r\n/* \r\nproc http \r\n        method=\"GET\" \r\n        url=\"https://webscraper.io/test-sites/e-commerce/allinone_test_error_url\"\r\n        out=scrape;\r\nrun;\r\n*/","outputs":[]},{"kind":1,"language":"markdown","value":"### b. View the file using the DATA step\r\nYou can also programmatically view the file in the log.","outputs":[]},{"kind":2,"language":"sas","value":"data _NULL_;\r\n    infile scrape;\r\n    input;\r\n    put _infile_;\r\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"### c. Create a SAS table by parsing the HTML using regular expressions\r\n\r\n#### Test HTML web scraping parsing logic","outputs":[]},{"kind":2,"language":"sas","value":"data raw_scrape;\r\n    infile scrape;\r\n    input;\r\n\r\n    /* Create regular expressions */\r\n    re_price = prxparse('/\\$\\d+(\\.\\d{2})?/'); \r\n    re_item = prxparse('/title=\"([^\"]+)/'); \r\n    re_desc = prxparse('/<p class=\"description card-text\">(.*?)<\\/p>/');\r\n\r\n    /* Read in the entire row of data into SAS in the column row */\r\n    row = _infile_;\r\n\r\n    /* \r\n    Find rows with necessary values \r\n    - Manual process to find what rows you need.\r\n    */\r\n    findRowPrice = find(row,'price');\r\n    findRowItem = find(row,'title=');\r\n    findRowDesc = find(row,'class=\"description');\r\n\r\n    if findRowPrice > 1 or\r\n       findRowItem > 1 or \r\n       findRowDesc > 1;\r\n\r\n    /*\r\n    If find the specified row, use regex to get the necessary value \r\n    */\r\n\r\n    /* Extract the price */\r\n    if findRowPrice > 1 then do;\r\n        start = prxmatch(re_price, row);\r\n        Price = prxposn(re_price, 0, row);\r\n    end;\r\n\r\n    /* Extract item name */\r\n    else if findRowItem > 1 then do;\r\n        start = prxmatch(re_item, row);\r\n        Item = tranwrd(prxposn(re_item, 0, row),'title=\"','');\r\n    end;\r\n\r\n    /* Extract description */\r\n    else if findRowDesc > 1 then do;\r\n        start = prxmatch(re_desc, row);\r\n        Description = prxposn(re_desc, 0, row);\r\n    end;\r\nrun;\r\n\r\n/* Preview data */\r\n%viewData(work.raw_scrape)\r\n\r\n/* View table metadata */\r\nods select Variables;\r\nproc contents data=work.raw_scrape;\r\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"Create the final structured table with the three items by using an array to store the values and output when the description is found.","outputs":[]},{"kind":2,"language":"sas","value":"data raw_scrape;\r\n    infile scrape;\r\n    input;\r\n\r\n    /* Create array of new columns to retain values as they are found */\r\n    array itemCols {*} $250 Price Item Description ('' '' '');\r\n\r\n    /* Create regular expressions */\r\n    re_price = prxparse('/\\$\\d+(\\.\\d{2})?/'); \r\n    re_item = prxparse('/title=\"([^\"]+)/'); \r\n    re_desc = prxparse('/<p class=\"description card-text\">(.*?)<\\/p>/');\r\n\r\n    /* Read in the entire row of data into SAS in the column row */\r\n    row = _infile_;\r\n\r\n    /* \r\n    Find rows with necessary values \r\n    - Manual process to find what rows you need.\r\n    */\r\n    findRowPrice = find(row,'price');\r\n    findRowItem = find(row,'title=');\r\n    findRowDesc = find(row,'class=\"description');\r\n\r\n    if findRowPrice > 1 or\r\n       findRowItem > 1 or \r\n       findRowDesc > 1;\r\n\r\n    /*\r\n    If find the specified row, use regex to get the necessary value \r\n    */\r\n\r\n    /* Extract the price */\r\n    if findRowPrice > 1 then do;\r\n        start = prxmatch(re_price, row);\r\n        Price = prxposn(re_price, 0, row);\r\n    end;\r\n\r\n    /* Extract item name */\r\n    else if findRowItem > 1 then do;\r\n        start = prxmatch(re_item, row);\r\n        Item = tranwrd(prxposn(re_item, 0, row),'title=\"','');\r\n    end;\r\n\r\n    /* Extract description and entire row. Assumption is when this is found, all values have been identified. Output this row */\r\n    else if findRowDesc > 1 then do;\r\n        start = prxmatch(re_desc, row);\r\n        Description = prxposn(re_desc, 0, row);\r\n        output;  /* Once the DESCRIPTION is found, output the entire row since all values were found */\r\n    end;\r\n\r\n    /* Drop columns */\r\n    drop re: find: row start;\r\nrun;\r\n\r\n/* Preview data */\r\n%viewData(work.raw_scrape)\r\n\r\n/* View table metadata */\r\nods select Variables;\r\nproc contents data=work.raw_scrape;\r\nrun;","outputs":[]},{"kind":1,"language":"markdown","value":"## General Notes:\r\n- Sometimes, JSON/XML RestAPI responses translate easily into a single structured table. Other times, it's a bit more complicated and requires joining data, as demonstrated in the World Bank Example. RestAPI responses are based on the design and requirements of their creators, typically optimized for their specific needs. This means that additional engineering may be necessary for our purposes.\r\n- Web scraping should be a last resort. The parsing of raw HTML is a fragile process. If a website changes its layout, it could break your entire pipeline. Always explore raw data sources or APIs to access data directly.\r\n- If possible, test your API responses in another tool like Postman. This will help identify any issues with the response and differentiate between potential problems in your SAS code or issues with the API.","outputs":[]},{"kind":1,"language":"markdown","value":"## Any Questions?\r\nFeel free to connect with me on LinkedIn!","outputs":[]}]